% mcgillnotes2.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mcgillnotes2}[2025/12/17 v13.0 Fixed Margins & Geometry]

%----------------------------------------------------------------------------------------
%   1. CORE PACKAGES
%----------------------------------------------------------------------------------------
\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage{mathpazo} % Palatino Font
\RequirePackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=1100,stretch=10,shrink=10]{microtype}
\RequirePackage{mathtools,amsmath,amssymb,amsthm,amsfonts}
\RequirePackage{dsfont,nicefrac}
\RequirePackage{titletoc}
\RequirePackage[dvipsnames, svgnames, x11names]{xcolor}
\RequirePackage{tikz,pgfplots}
\usepgfplotslibrary{colormaps}
\RequirePackage[labelfont=bf,textfont=md]{caption}
\RequirePackage{capt-of}
\RequirePackage{etoolbox}
\RequirePackage{lettrine}
\RequirePackage[explicit,newlinetospace]{titlesec}
\RequirePackage{tcolorbox}
\tcbuselibrary{skins, breakable, theorems}
\RequirePackage{cleveref}
\RequirePackage{array,tabularx,booktabs}
\RequirePackage{sectsty} 
\RequirePackage{fancyhdr}
\RequirePackage{setspace}

% Line spacing (1.15 is slightly more readable than single-spaced)
\setstretch{1.15}

%----------------------------------------------------------------------------------------
%   2. STRICT GEOMETRY (Calculated to fit 8.5" Letter Paper)
%----------------------------------------------------------------------------------------
\RequirePackage{geometry}
\geometry{
    letterpaper,
    left=25.4mm,           % Left margin (1 inch)
    right=25.4mm,          % Right margin (1 inch)
    top=25.4mm,            % Top margin
    bottom=25.4mm,         % Bottom margin
    heightrounded,
    verbose               % Logs dimensions to ensure fit
}

% Redefine \maketitle to use centered geometry for title page
\let\oldmaketitle\maketitle
\renewcommand{\maketitle}{%
  \newgeometry{margin=1in}% Symmetric margins for title page
  \oldmaketitle
  \restoregeometry% Return to main layout
}

% Start section numbering at 1 (remove chapter prefix in report class)
\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}

% Headers and Footers
\pagestyle{fancy}
\fancyhead{} 
\fancyhead[L]{\small \sffamily \color{gray} \rightmark} 
\fancyhead[R]{\small \bfseries \thepage} 
\fancyfoot{} 
\renewcommand{\headrulewidth}{0pt}

% Make \rightmark show section name (not subsection)
\renewcommand{\sectionmark}[1]{\markright{#1}}

% Use numbers for footnotes (not letters or symbols)
\renewcommand{\thefootnote}{\arabic{footnote}}
\renewcommand{\thempfootnote}{\arabic{mpfootnote}}  % For minipages/tcolorboxes

% Section Fonts
\allsectionsfont{\normalfont\sffamily\bfseries\color{MidnightBlue}} 

%----------------------------------------------------------------------------------------
%   MATH LINE BREAKING
%----------------------------------------------------------------------------------------
\allowdisplaybreaks                    % Allow page breaks in multi-line equations
\setlength{\emergencystretch}{3em}     % Allow extra stretch to avoid overfull boxes
\tolerance=1000                        % More flexible line breaking
\hfuzz=2pt                             % Suppress warnings for small overflows

%----------------------------------------------------------------------------------------
%   3. COLORS (Castel / Paquette Palette)
%----------------------------------------------------------------------------------------
\definecolor{thmBlue}{RGB}{142, 100, 140}   % Purple/mauve header
\definecolor{thmBack}{RGB}{246, 242, 243}   % Light grayish background
\definecolor{defGreen}{RGB}{203, 156, 86}   % Warm gold/tan for left bar
\definecolor{defHeader}{RGB}{160, 115, 50}   % Darker gold for header text
\definecolor{defBack}{RGB}{254, 247, 239}    % Light cream background
\definecolor{exOrange}{RGB}{203, 155, 91}  % Warm tan/gold
\definecolor{exBack}{RGB}{254, 247, 239}    % Light cream
\definecolor{propPurple}{RGB}{130, 0, 150}
\definecolor{propHeader}{RGB}{100, 0, 120}   % Darker purple for header text
\definecolor{propBack}{RGB}{252, 248, 255}   % Lighter purple tint
\definecolor{goalBlue}{RGB}{70, 130, 180}    % Steel blue for goal box
\definecolor{goalHeader}{RGB}{50, 100, 150}  % Darker blue for header
\definecolor{goalBack}{RGB}{240, 248, 255}   % Alice blue background

%----------------------------------------------------------------------------------------
%   4. THEOREMS & ENVIRONMENTS (Wrapped in Boxes)
%----------------------------------------------------------------------------------------
% Theorem counter (resets per subsection)
\newcounter{thm}[subsection]
\renewcommand{\thethm}{\thesubsection.\arabic{thm}}

\theoremstyle{plain}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}

\theoremstyle{lemma}
\newtheorem{lem}[thm]{Lemma}

\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition}
\newtheorem{rem}[thm]{Remark}

% --- THEOREM BOX (with title bar) ---
\newtcolorbox{thm}[1][]{
    enhanced,
    colframe=thmBlue,
    colback=thmBack,
    colbacktitle=thmBlue,
    coltitle=white,
    fonttitle=\sffamily,
    boxrule=2pt,
    arc=4pt,
    toptitle=3pt,
    bottomtitle=3pt,
    breakable,
    left=12pt, right=12pt, top=8pt, bottom=10pt,
    before skip=12pt, after skip=12pt,
    title={\bfseries Theorem~\refstepcounter{thm}\thethm\ifstrempty{#1}{}{\normalfont\sffamily: #1}}
}

% --- PROPOSITION BOX ---
\tcolorboxenvironment{prop}{
    enhanced jigsaw,
    colframe=propPurple, colback=propBack,
    boxrule=0pt, leftrule=3pt,
    sharp corners, breakable,
    left=8pt, right=8pt, top=8pt, bottom=8pt,
    parbox=false,
    before skip=12pt, after skip=12pt
}

% --- LEMMA BOX ---
\tcolorboxenvironment{lem}{
    enhanced jigsaw,
    colframe=propPurple, colback=propBack,
    boxrule=0pt, leftrule=3pt,
    sharp corners, breakable,
    left=8pt, right=8pt, top=8pt, bottom=8pt,
    parbox=false,
    before skip=12pt, after skip=12pt
}

% --- COROLLARY BOX ---
\tcolorboxenvironment{cor}{
    enhanced jigsaw,
    colframe=propPurple, colback=propBack,
    boxrule=0pt, leftrule=3pt,
    sharp corners, breakable,
    left=8pt, right=8pt, top=8pt, bottom=8pt,
    parbox=false,
    before skip=12pt, after skip=12pt
}

% --- DEFINITION BOX ---
\tcolorboxenvironment{defn}{
    enhanced jigsaw,
    colframe=defGreen, colback=defBack,
    boxrule=0pt, leftrule=3pt,
    sharp corners, breakable,
    left=8pt, right=8pt, top=8pt, bottom=8pt,
    parbox=false,
    before skip=12pt, after skip=12pt
}

% --- EXAMPLE BOX (with title bar) ---
\newtcolorbox{exmp}[1][]{
    enhanced,
    colframe=exOrange,
    colback=exBack,
    colbacktitle=exOrange,
    coltitle=white,
    fonttitle=\bfseries\sffamily,
    boxrule=2pt,
    arc=4pt,
    toptitle=3pt,
    bottomtitle=3pt,
    breakable,
    left=12pt, right=12pt, top=8pt, bottom=10pt,
    before skip=12pt, after skip=12pt,
    title={\bfseries Example~\refstepcounter{thm}\thethm\ifstrempty{#1}{}{\normalfont\sffamily: #1}}
}

% --- GOAL/QUESTION/FACT BOX (with title bar) ---
% Use \begin{goal} for "Goal", \begin{goal}[question] for "Question", \begin{goal}[fact] for "Fact"
\newtcolorbox{goal}[1][goal]{
    enhanced,
    colframe=goalBlue,
    colback=goalBack,
    colbacktitle=goalBlue,
    coltitle=white,
    fonttitle=\bfseries\sffamily,
    boxrule=2pt,
    arc=4pt,
    toptitle=3pt,
    bottomtitle=3pt,
    breakable,
    left=12pt, right=12pt, top=8pt, bottom=10pt,
    before skip=12pt, after skip=12pt,
    title={\bfseries\ifstrequal{#1}{question}{Question}{\ifstrequal{#1}{fact}{Fact}{Goal}}}
}

% --- REMARK BOX ---
\tcolorboxenvironment{rem}{
    enhanced jigsaw,
    colframe=gray!60, colback=gray!8,
    boxrule=0pt, leftrule=2pt,
    sharp corners, breakable,
    left=8pt, right=8pt, top=2pt, bottom=2pt,
    parbox=false,
    before skip=10pt, after skip=10pt
}

%----------------------------------------------------------------------------------------
%   5. HEADER STYLING
%----------------------------------------------------------------------------------------
\makeatletter
\def\th@plain{%
  \thm@notefont{\bfseries\sffamily\color{propHeader}}%  % Darker purple for header
  \normalfont
  \thm@headpunct{:}%
  \thm@headsep 5\p@ plus\p@ minus\p@
  \thm@headfont{\bfseries\sffamily\color{propHeader}} 
}
\def\th@lemma{%
  \thm@notefont{\bfseries\sffamily\color{propHeader}}%  % Darker purple for lemmas
  \normalfont
  \thm@headpunct{:}%
  \thm@headsep 5\p@ plus\p@ minus\p@
  \thm@headfont{\bfseries\sffamily\color{propHeader}} 
}
\def\th@definition{%
  \thm@notefont{\bfseries\sffamily\color{defHeader}}%  % Darker gold for header
  \normalfont
  \thm@headpunct{:}%
  \thm@headsep 5\p@ plus\p@ minus\p@
  \thm@headfont{\bfseries\sffamily\color{defHeader}} 
}

% Restyle proof environment
\renewenvironment{proof}[1][\proofname]{%
  \par\pushQED{\qed}%
  \normalfont \topsep6\p@\@plus6\p@\relax
  \trivlist
  \item[\hskip\labelsep\bfseries\sffamily\color{defHeader}#1\@addpunct{.}]\ignorespaces
}{%
  \popQED\endtrivlist\@endpefalse
}
\makeatother

%----------------------------------------------------------------------------------------
%   6. UTILITIES
%----------------------------------------------------------------------------------------
\newcommand{\R}{\mathbb{R}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}} 
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\C}{\mathbb{C}}
\renewcommand{\P}{\mathbb{P}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\norm}[1]{\left\lVert #1 \right\rVert}
\DeclareMathOperator{\interior}{Int}
\DeclareMathOperator{\exterior}{Ext}